# setTimeout

`setTimeout` 是一个用于延迟执行代码的 JavaScript 函数。为了更好地理解 `setTimeout` 的运行机制，需要了解 JavaScript 的单线程特性、事件循环（Event Loop）、任务队列（Task Queue）等概念。

## JavaScript 单线程

JavaScript 是一种单线程语言，这意味着在任意时刻只能执行一个任务。单线程模型简化了编程和调试，但也带来了挑战，特别是在处理 I/O 操作（如网络请求、文件读取）和用户交互（如点击事件）时。

## 任务队列和事件循环

为了管理异步任务，JavaScript 引入了任务队列和事件循环的概念。

### 1. Call Stack（调用栈）

调用栈是一种数据结构，保存着所有正在执行的函数。当一个函数被调用时，它会被压入栈顶；当函数执行完毕时，它会从栈顶弹出。

### 2. Task Queue（任务队列）

任务队列是一个队列（FIFO），用于存放异步任务（如通过 `setTimeout` 设置的回调函数）。当调用 `setTimeout` 时，指定的回调函数会被添加到任务队列中。

### 3. Event Loop（事件循环）

事件循环是一个不断检查调用栈和任务队列的循环机制。当调用栈为空时，事件循环会从任务队列中取出第一个任务并将其压入调用栈，开始执行。

## `setTimeout` 的运行机制

1. **调用 `setTimeout`**：当 `setTimeout` 被调用时，会设置一个定时器，并指定一个回调函数和延迟时间（毫秒）。

2. **定时器到期**：当定时器到期后，回调函数会被放入任务队列中。

3. **事件循环检查**：事件循环不断检查调用栈是否为空，如果调用栈为空，就会从任务队列中取出第一个任务（即回调函数）并开始执行。

下面是一个简单的示例，演示了 `setTimeout` 的工作机制：

```javascript
console.log("开始");

setTimeout(() => {
  console.log("这是延迟执行的代码");
}, 1000);

console.log("结束");
```

输出结果：

```plaintext
开始
结束
这是延迟执行的代码
```

1. **`console.log("开始")`**：首先执行，输出 "开始"。
2. **`setTimeout`**：设置一个定时器，将回调函数放入任务队列中，延迟时间为 1000 毫秒。
3. **`console.log("结束")`**：立即执行，输出 "结束"。
4. **定时器到期**：1000 毫秒后，回调函数被放入任务队列中。
5. **事件循环检查**：调用栈为空，事件循环将回调函数从任务队列中取出并执行，输出 "这是延迟执行的代码"。

## 事件循环和任务队列的详细流程

1. **初始化**：执行全局代码，函数调用会被压入调用栈。
2. **执行同步代码**：调用栈中的同步代码按顺序执行。
3. **设置异步任务**：当遇到异步任务（如 `setTimeout`）时，设置定时器并将回调函数放入任务队列中。
4. **事件循环检查**：事件循环不断检查调用栈是否为空。
5. **处理任务队列**：当调用栈为空时，事件循环从任务队列中取出第一个任务并执行。
6. **重复循环**：上述过程不断重复，直到所有任务执行完毕。

## 微任务（Microtasks）和宏任务（Macrotasks）

在 JavaScript 中，任务分为两类：微任务和宏任务。

### 宏任务（Macrotasks）

宏任务包括 `setTimeout`、`setInterval`、I/O 操作等。每次事件循环只会执行一个宏任务，然后检查微任务队列。

### 微任务（Microtasks）

微任务包括 `Promise` 的回调函数、`MutationObserver` 等。每次事件循环结束后，都会执行所有微任务队列中的任务。

```javascript
console.log("开始");

setTimeout(() => {
  console.log("这是宏任务");
}, 0);

Promise.resolve().then(() => {
  console.log("这是微任务");
});

console.log("结束");
```

输出结果：

```plaintext
开始
结束
这是微任务
这是宏任务
```

1. **同步代码**：`console.log("开始")` 和 `console.log("结束")` 立即执行。
2. **设置宏任务**：`setTimeout` 将回调函数添加到任务队列中。
3. **设置微任务**：`Promise` 将回调函数添加到微任务队列中。
4. **执行微任务**：在事件循环结束后，所有微任务队列中的任务立即执行。
5. **执行宏任务**：在下一次事件循环中，任务队列中的宏任务开始执行。

参考：

- [介绍一下 setTimeout 的运行机制](https://fe.ecool.fun/topic/cdeec2cc-5772-4c63-b7f0-34f864ea886d?orderBy=updateTime&order=desc&tagId=10)
